import random
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)
import google.generativeai as genai

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
BOT_TOKEN = "–í–°–¢–ê–í–¨_–¢–ï–õ–ï–ì–†–ê–ú_–¢–û–ö–ï–ù"
GEMINI_API_KEY = "–í–°–¢–ê–í–¨_GEMINI_API_KEY"

genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel("gemini-pro")

# ================== –ö–ù–û–ü–ö–ò ==================
keyboard = ReplyKeyboardMarkup(
    [
        ["üé≤ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ", "üìù –°—á—ë—Ç —Å–ª–æ–≤"],
        ["üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä", "ü§ñ Gemini"],
        ["üßπ –û—á–∏—Å—Ç–∏—Ç—å Gemini-–ø–∞–º—è—Ç—å"]
    ],
    resize_keyboard=True
)

# ================== /start ==================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    await update.message.reply_text(
        "ü§ñ –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç —Å Gemini-–ø–∞–º—è—Ç—å—é.\n–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º üëá",
        reply_markup=keyboard
    )

# ================== –£–ì–ê–î–ê–ô –ß–ò–°–õ–û ==================
async def guess_game(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data.clear()
    context.user_data["mode"] = "guess"
    context.user_data["secret"] = random.randint(1, 15)
    context.user_data["attempts"] = 5

    await update.message.reply_text(
        "üé≤ –Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 15.\n–£ —Ç–µ–±—è 5 –ø–æ–ø—ã—Ç–æ–∫!"
    )

# ================== –û–ë–†–ê–ë–û–¢–ö–ê ==================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    # ===== –∫–Ω–æ–ø–∫–∏ =====
    if text == "üé≤ –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ":
        await guess_game(update, context)
        return

    if text == "üìù –°—á—ë—Ç —Å–ª–æ–≤":
        context.user_data.clear()
        context.user_data["mode"] = "count"
        await update.message.reply_text("‚úçÔ∏è –í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç:")
        return

    if text == "üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä":
        context.user_data.clear()
        context.user_data["mode"] = "calc"
        await update.message.reply_text("üßÆ –í–≤–µ–¥–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä: 5 * 8)")
        return

    if text == "ü§ñ Gemini":
        context.user_data.clear()
        context.user_data["mode"] = "gemini"
        context.user_data["history"] = []
        await update.message.reply_text("ü§ñ Gemini –≤–∫–ª—é—á—ë–Ω. –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
        return

    if text == "üßπ –û—á–∏—Å—Ç–∏—Ç—å Gemini-–ø–∞–º—è—Ç—å":
        context.user_data["history"] = []
        await update.message.reply_text("üßπ –ü–∞–º—è—Ç—å Gemini –æ—á–∏—â–µ–Ω–∞")
        return

    mode = context.user_data.get("mode")

    # --- —É–≥–∞–¥–∞–π —á–∏—Å–ª–æ ---
    if mode == "guess":
        if not text.isdigit():
            await update.message.reply_text("‚ùó –í–≤–µ–¥–∏ —á–∏—Å–ª–æ")
            return

        guess = int(text)
        context.user_data["attempts"] -= 1

        if guess < context.user_data["secret"]:
            await update.message.reply_text("‚¨ÜÔ∏è –ë–æ–ª—å—à–µ")
        elif guess > context.user_data["secret"]:
            await update.message.reply_text("‚¨áÔ∏è –ú–µ–Ω—å—à–µ")
        else:
            await update.message.reply_text("üéâ –¢—ã —É–≥–∞–¥–∞–ª!")
            context.user_data.clear()
            return

        if context.user_data["attempts"] == 0:
            await update.message.reply_text(
                f"‚ùå –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã. –ë—ã–ª–æ —á–∏—Å–ª–æ {context.user_data['secret']}"
            )
            context.user_data.clear()

    # --- —Å—á—ë—Ç —Å–ª–æ–≤ ---
    elif mode == "count":
        await update.message.reply_text(
            f"üìù –°–ª–æ–≤: {len(text.split())}\nüî¢ –°–∏–º–≤–æ–ª–æ–≤: {len(text)}"
        )

    # --- –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ---
    elif mode == "calc":
        try:
            result = eval(text, {"__builtins__": {}})
            await update.message.reply_text(f"üßÆ –†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
        except:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏")

    # --- GEMINI –° –ü–ê–ú–Ø–¢–¨–Æ ---
    elif mode == "gemini":
        history = context.user_data.get("history", [])

        history.append(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {text}")
        history = history[-10:]

        prompt = "\n".join(history)

        try:
            response = model.generate_content(prompt)
            answer = response.text

            history.append(f"–ë–æ—Ç: {answer}")
            context.user_data["history"] = history

            await update.message.reply_text(answer)

        except Exception as e:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ Gemini")
            print(e)

# ================== –ó–ê–ü–£–°–ö ==================
app = ApplicationBuilder().token(BOT_TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
app.run_polling()